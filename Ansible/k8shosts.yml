---
- name: Install docker and configure for k8s
  hosts: k8shosts
  become: yes
  tasks:
  - name: Docker repository
    yum_repository:
      description: Docker Repo
      file: kubernetes
      baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
      enabled: yes
      gpgcheck: yes
      repo_gpgcheck: yes
      gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

  - name: Disable SELinux
    ansible.posix.selinux:
      state: disabled

  - name: Stop and disable firewalld.
    service:
        name: firewalld
        state: stopped
        enabled: False

  - name: Install kubernetes
    yum:
      name: "{{ packages }}"
    vars:
      packages:
      - kubelet
      - kubeadm
      - kubectl

  - name: Enable and start kubelet
    ansible.builtin.systemd:
      name: kubelet
      state: started
      enabled: yes

  - name: Disable swap for current session
    command: swapoff -a
    become: true

  - name: Disable swap permanently, persist reboots
    replace:
      path: /etc/fstab
      regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
      replace: '#\1\2\3swap\4'
      backup: yes